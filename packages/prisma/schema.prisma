// DearMe Database Schema
// Provider: Neon Postgres with extensions

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, citext]
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

// ============================================================================
// ENUMS
// ============================================================================

// Subscription plans aligned to Capsule Note pricing
enum PlanType {
  DIGITAL_CAPSULE
  PAPER_PIXELS

  @@map("plan_type")
}

enum LetterType {
  email
  physical

  @@map("letter_type")
}

enum LetterStatus {
  DRAFT
  SCHEDULED
  LOCKED
  SENT
  FAILED
  BOUNCED
  CANCELLED

  @@map("letter_status")
}

// ============================================================================
// USERS & PROFILES
// ============================================================================

model User {
  id              String   @id @default(uuid()) @db.Uuid
  clerkUserId     String?  @unique @map("clerk_user_id")
  email           String   @unique @db.Citext
  planType        PlanType? @map("plan_type")
  emailCredits    Int      @default(0) @map("email_credits")
  physicalCredits Int      @default(0) @map("physical_credits")
  creditExpiresAt DateTime? @map("credit_expires_at") @db.Timestamptz(3)
  /// @deprecated Use Profile.timezone instead. This field is kept for backward compatibility.
  timezone        String?  @default("UTC")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  profile           Profile?
  letters           Letter[]
  deliveries        Delivery[]
  subscriptions     Subscription[]
  subscriptionUsage SubscriptionUsage[]
  shippingAddresses ShippingAddress[]
  payments          Payment[]
  auditEvents       AuditEvent[]
  addOnPurchases    AddOnPurchase[]
  referralCode      ReferralCode?
  referralsMade     Referral[]         @relation("ReferrerReferrals")
  referralsReceived Referral[]         @relation("RefereeReferrals")
  pushSubscriptions PushSubscription[]

  @@map("users")
}

model Profile {
  userId              String   @id @map("user_id") @db.Uuid
  displayName         String?  @map("display_name")
  timezone            String   @default("UTC") // IANA timezone - canonical source for user timezone
  marketingOptIn      Boolean  @default(false) @map("marketing_opt_in")
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  stripeCustomerId    String?  @unique @map("stripe_customer_id")
  pushEnabled         Boolean  @default(false) @map("push_enabled") // Push notifications preference
  referredByCode      String?  @map("referred_by_code") // Referral code used at signup
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  unpaid
  paused

  @@map("subscription_status")
}

model Subscription {
  id                   String             @id @default(uuid()) @db.Uuid
  userId               String             @map("user_id") @db.Uuid
  stripeSubscriptionId String             @unique @map("stripe_subscription_id")
  status               SubscriptionStatus @default(trialing)
  plan                 PlanType           @default(DIGITAL_CAPSULE)
  currentPeriodEnd     DateTime           @map("current_period_end") @db.Timestamptz(3)
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  createdAt            DateTime           @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt            DateTime           @updatedAt @map("updated_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// ============================================================================
// LETTERS
// ============================================================================

enum LetterVisibility {
  private
  link

  @@map("letter_visibility")
}

model Letter {
  id              String           @id @default(uuid()) @db.Uuid
  userId          String           @map("user_id") @db.Uuid
  title           String
  bodyCiphertext  Bytes            @map("body_ciphertext") // Encrypted content
  bodyNonce       Bytes            @map("body_nonce") // Encryption nonce
  bodyFormat      String           @default("rich") @map("body_format") // md|html|rich
  keyVersion      Int              @default(1) @map("key_version") // For key rotation
  visibility      LetterVisibility @default(private)
  tags            String[]         @default([])
  type            LetterType       @default(email)
  status          LetterStatus     @default(DRAFT)
  scheduledFor    DateTime?        @map("scheduled_for") @db.Timestamptz(3)
  timezone        String           @default("UTC")
  lockedAt        DateTime?        @map("locked_at") @db.Timestamptz(3)
  shareLinkToken  String           @unique @default(uuid()) @map("share_link_token")
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz(3)
  deletedAt       DateTime?        @map("deleted_at") @db.Timestamptz(3)

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries Delivery[]
  deliveryAttempts DeliveryAttempt[]

  @@index([userId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([keyVersion])
  @@map("letters")
}

// ============================================================================
// DELIVERIES
// ============================================================================

enum DeliveryChannel {
  email
  mail

  @@map("delivery_channel")
}

enum DeliveryStatus {
  scheduled
  processing
  sent
  failed
  canceled

  @@map("delivery_status")
}

model Delivery {
  id                  String          @id @default(uuid()) @db.Uuid
  userId              String          @map("user_id") @db.Uuid
  letterId            String          @map("letter_id") @db.Uuid
  channel             DeliveryChannel
  deliverAt           DateTime        @map("deliver_at") @db.Timestamptz(3)
  timezoneAtCreation  String          @map("timezone_at_creation") // IANA timezone
  status              DeliveryStatus  @default(scheduled)
  inngestRunId        String?         @map("inngest_run_id")
  lastError           String?         @map("last_error") @db.Text
  attemptCount        Int             @default(0) @map("attempt_count")
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz(3)

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  letter         Letter           @relation(fields: [letterId], references: [id], onDelete: Cascade)
  emailDelivery  EmailDelivery?
  mailDelivery   MailDelivery?

  @@unique([letterId, channel, deliverAt])
  @@index([userId])
  @@index([letterId])
  @@index([status])
  @@index([deliverAt])
  @@index([status, deliverAt])
  @@map("deliveries")
}

model EmailDelivery {
  deliveryId       String   @id @map("delivery_id") @db.Uuid
  toEmail          String   @map("to_email") @db.Citext
  subject          String
  resendMessageId  String?  @map("resend_message_id")
  opens            Int      @default(0)
  clicks           Int      @default(0)
  bounces          Int      @default(0)
  lastOpenedAt     DateTime? @map("last_opened_at") @db.Timestamptz(3)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([resendMessageId])
  @@map("email_deliveries")
}

enum MailDeliveryMode {
  send_on   // Letter mailed on specific date
  arrive_by // Letter arrives by specific date

  @@map("mail_delivery_mode")
}

model MailDelivery {
  deliveryId         String            @id @map("delivery_id") @db.Uuid
  shippingAddressId  String            @map("shipping_address_id") @db.Uuid
  deliveryMode       MailDeliveryMode  @default(send_on) @map("delivery_mode")
  targetDate         DateTime?         @map("target_date") @db.Timestamptz(3) // User's desired date
  sendDate           DateTime?         @map("send_date") @db.Timestamptz(3) // Calculated for arrive_by
  transitDays        Int?              @map("transit_days") // Estimated from provider
  lobJobId           String?           @map("lob_job_id")
  printOptions       Json              @map("print_options") // { color, doubleSided, etc. }
  previewUrl         String?           @map("preview_url")
  trackingStatus     String?           @map("tracking_status")
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz(3)

  delivery        Delivery         @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  shippingAddress ShippingAddress  @relation(fields: [shippingAddressId], references: [id])

  @@index([lobJobId])
  @@map("mail_deliveries")
}

model DeliveryAttempt {
  id           String          @id @default(uuid()) @db.Uuid
  letterId     String          @map("letter_id") @db.Uuid
  channel      DeliveryChannel
  status       DeliveryStatus
  errorCode    String?         @map("error_code")
  errorMessage String?         @map("error_message") @db.Text
  createdAt    DateTime        @default(now()) @map("created_at") @db.Timestamptz(3)

  letter       Letter          @relation(fields: [letterId], references: [id], onDelete: Cascade)

  @@index([letterId])
  @@index([status])
  @@map("delivery_attempts")
}

// ============================================================================
// SHIPPING ADDRESSES
// ============================================================================

model ShippingAddress {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String
  line1       String
  line2       String?
  city        String
  state       String
  postalCode  String   @map("postal_code")
  country     String   @db.Char(2) // ISO 3166-1 alpha-2
  metadata    Json     @default("{}") // e.g., verification status from Lob
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  mailDeliveries MailDelivery[]

  @@index([userId])
  @@map("shipping_addresses")
}

// ============================================================================
// PAYMENTS
// ============================================================================

enum PaymentType {
  subscription
  shipping_addon

  @@map("payment_type")
}

enum PaymentStatus {
  succeeded
  failed
  pending
  refunded

  @@map("payment_status")
}

model Payment {
  id                     String        @id @default(uuid()) @db.Uuid
  userId                 String        @map("user_id") @db.Uuid
  type                   PaymentType
  amountCents            Int           @map("amount_cents")
  currency               String        @default("usd") @db.Char(3)
  stripePaymentIntentId  String?       @map("stripe_payment_intent_id")
  status                 PaymentStatus @default(pending)
  metadata               Json          @default("{}")
  createdAt              DateTime      @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt              DateTime      @updatedAt @map("updated_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid // Nullable for system events
  type      String   // e.g., "letter.created", "delivery.sent"
  data      Json     @default("{}")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("audit_events")
}

// ============================================================================
// LETTER TEMPLATES
// ============================================================================

model LetterTemplate {
  id            String   @id @default(uuid()) @db.Uuid
  category      String   // reflections, goals, gratitude, therapy
  title         String
  description   String?  @db.Text
  promptText    String   @map("prompt_text") @db.Text // Pre-written prompt
  placeholders  Json     @default("{}") // Dynamic placeholders
  isActive      Boolean  @default(true) @map("is_active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  @@index([category])
  @@index([isActive])
  @@map("letter_templates")
}

// ============================================================================
// SUBSCRIPTION USAGE TRACKING
// ============================================================================

model SubscriptionUsage {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  period         DateTime @map("period") @db.Timestamptz(3) // Billing period start
  lettersCreated Int      @default(0) @map("letters_created")
  emailsSent     Int      @default(0) @map("emails_sent")
  mailsSent      Int      @default(0) @map("mails_sent")
  mailCredits    Int      @default(0) @map("mail_credits") // Physical mail credits
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period], map: "subscription_usage_user_period_unique")
  @@index([userId])
  @@index([period])
  @@map("subscription_usage")
}

// ============================================================================
// WEBHOOK EVENT TRACKING
// ============================================================================

model WebhookEvent {
  id          String   @id // Use Stripe event.id for natural idempotency
  type        String   // event.type
  processedAt DateTime @default(now()) @map("processed_at") @db.Timestamptz(3)
  data        Json     @default("{}") // Full event payload for debugging

  @@index([type])
  @@index([processedAt])
  @@map("webhook_events")
}

// ============================================================================
// PRICING PLANS
// ============================================================================

model PricingPlan {
  id              String           @id @default(uuid()) @db.Uuid
  stripeProductId String           @unique @map("stripe_product_id")
  stripePriceId   String           @unique @map("stripe_price_id")
  name            String           // "Pro Monthly"
  plan            PlanType
  interval        String           // "month" | "year"
  amountCents     Int              @map("amount_cents")
  currency        String           @default("usd") @db.Char(3)
  features        Json             @default("{}") // Feature matrix
  isActive        Boolean          @default(true) @map("is_active")
  sortOrder       Int              @default(0) @map("sort_order")
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz(3)

  @@index([plan])
  @@index([isActive])
  @@map("pricing_plans")
}

// ============================================================================
// FAILED WEBHOOKS - Dead Letter Queue
// ============================================================================

model FailedWebhook {
  id         String    @id @default(uuid()) @db.Uuid
  eventId    String    @map("event_id")
  eventType  String    @map("event_type")
  payload    Json
  error      String    @db.Text
  retriedAt  DateTime  @default(now()) @map("retried_at") @db.Timestamptz(3)
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz(3)

  @@index([eventType])
  @@index([retriedAt])
  @@map("failed_webhooks")
}

// ============================================================================
// PENDING SUBSCRIPTIONS - Anonymous Checkout Support
// ============================================================================

enum PendingSubscriptionStatus {
  awaiting_payment // Checkout created, payment pending
  payment_complete // Payment succeeded, awaiting signup
  linked           // Successfully linked to user account
  expired          // Expired without signup
  refunded         // Refunded due to expiry

  @@map("pending_subscription_status")
}

model PendingSubscription {
  id                   String                    @id @default(uuid()) @db.Uuid
  email                String                    @db.Citext // Case-insensitive, links to User.email

  // Stripe references
  stripeCustomerId     String                    @unique @map("stripe_customer_id")
  stripeSessionId      String                    @unique @map("stripe_session_id")
  stripeSubscriptionId String?                   @unique @map("stripe_subscription_id") // Null until payment

  // Plan details
  priceId              String                    @map("price_id")
  plan                 PlanType
  amountCents          Int                       @map("amount_cents")
  currency             String                    @default("usd") @db.Char(3)

  // Status tracking
  status               PendingSubscriptionStatus @default(awaiting_payment)
  paymentStatus        String?                   @map("payment_status") // From Stripe

  // Metadata
  metadata             Json                      @default("{}") // { letterId, source, etc }

  // Communication tracking (P0 fixes)
  webhookProcessedAt      DateTime? @map("webhook_processed_at") @db.Timestamptz(3)
  confirmationEmailSentAt DateTime? @map("confirmation_email_sent_at") @db.Timestamptz(3)

  // Lifecycle
  expiresAt            DateTime                  @map("expires_at") @db.Timestamptz(3) // 30 days from creation
  linkedAt             DateTime?                 @map("linked_at") @db.Timestamptz(3)
  linkedUserId         String?                   @db.Uuid @map("linked_user_id") // Audit trail

  createdAt            DateTime                  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt            DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(3)

  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@index([email, status])
  @@map("pending_subscriptions")
}

// ============================================================================
// ANONYMOUS DRAFTS - Letter Draft Restoration Support
// ============================================================================

model AnonymousDraft {
  id             String    @id @default(uuid()) @db.Uuid
  sessionId      String    // From cookie middleware
  email          String    @db.Citext // Case-insensitive

  // Letter content (unencrypted for anonymous users)
  title          String
  body           String    @db.Text
  recipientEmail String    @db.Citext
  deliveryDate   String    // ISO string format
  deliveryType   String?   @map("delivery_type")
  timezone       String?   @map("timezone")

  // Lifecycle
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  expiresAt      DateTime  @map("expires_at") @db.Timestamptz(3) // 7 days from creation
  claimedAt      DateTime? @map("claimed_at") @db.Timestamptz(3)
  claimedByUserId String?  @db.Uuid @map("claimed_by_user_id")

  @@unique([sessionId, email], map: "anonymous_drafts_session_email_unique")
  @@index([email, claimedAt])
  @@index([sessionId, expiresAt])
  @@index([expiresAt]) // For cleanup job
  @@map("anonymous_drafts")
}

// ============================================================================
// ADD-ON PURCHASES
// ============================================================================

enum AddOnType {
  email
  physical

  @@map("addon_type")
}

model AddOnPurchase {
  id                    String    @id @default(uuid()) @db.Uuid
  userId                String    @map("user_id") @db.Uuid
  type                  AddOnType
  quantity              Int
  amountCents           Int       @map("amount_cents")
  currency              String    @default("usd") @db.Char(3)
  stripePaymentIntentId String?   @unique @map("stripe_payment_intent_id")
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addon_purchases")
}

// ============================================================================
// REFERRAL SYSTEM
// ============================================================================

enum ReferralStatus {
  pending    // Invite sent, not signed up
  signed_up  // Signed up but not subscribed
  converted  // Subscribed (paid)
  rewarded   // Both parties credited
  expired    // Never converted within window

  @@map("referral_status")
}

model ReferralCode {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @unique @map("user_id") @db.Uuid
  code         String    @unique @db.VarChar(12) // e.g., "JANE42XY"
  clickCount   Int       @default(0) @map("click_count")
  signupCount  Int       @default(0) @map("signup_count")
  convertCount Int       @default(0) @map("convert_count")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
  @@map("referral_codes")
}

model Referral {
  id             String         @id @default(uuid()) @db.Uuid
  referralCodeId String         @map("referral_code_id") @db.Uuid
  referrerId     String         @map("referrer_id") @db.Uuid
  refereeUserId  String?        @map("referee_user_id") @db.Uuid // Null until signup
  refereeEmail   String?        @map("referee_email") @db.Citext // For tracking before signup
  status         ReferralStatus @default(pending)
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(3)
  signedUpAt     DateTime?      @map("signed_up_at") @db.Timestamptz(3)
  convertedAt    DateTime?      @map("converted_at") @db.Timestamptz(3)
  rewardedAt     DateTime?      @map("rewarded_at") @db.Timestamptz(3)

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id])
  referrer     User         @relation("ReferrerReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  referee      User?        @relation("RefereeReferrals", fields: [refereeUserId], references: [id], onDelete: SetNull)

  @@unique([referralCodeId, refereeEmail])
  @@index([referrerId])
  @@index([refereeUserId])
  @@index([status])
  @@map("referrals")
}

// ============================================================================
// PUSH NOTIFICATIONS
// ============================================================================

model PushSubscription {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  endpoint   String    @unique @db.Text // Web Push endpoint URL
  p256dh     String    @db.Text // Public key for encryption
  auth       String    @db.Text // Auth secret
  userAgent  String?   @map("user_agent")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}
